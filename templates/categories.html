<!DOCTYPE html>
<html lang="fr">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rubriques — Journal du lycée</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/categories.css">
  <link rel="stylesheet" href="/static/fixe_header.css">
</head>
<body>

  <!-- Barre supérieure -->
  <header class="container header" role="banner">
      <a class="brand" href="/">Journal du lycée</a>

      <nav class="nav" aria-label="Navigation principale">
        <a
          class="nav-link {% if request.url.path == '/' %}is-active{% endif %}"
          href="/"
        >
          Accueil
          <svg
            class="nav-ring"
            aria-hidden="true"
            focusable="false"
            viewBox="0 0 100 40"
            preserveAspectRatio="none"
          >
            <path
              class="nav-ring__stroke"
              pathLength="100"
              d="M50,1.5 H78.5 A18.5,18.5 0 0 1 78.5,38.5 H21.5 A18.5,18.5 0 0 1 21.5,1.5 H50 Z"
            />
          </svg>
        </a>

        <a
          class="nav-link {% if request.url.path.startswith('/categories') %}is-active{% endif %}"
          href="/categories"
        >
          Rubriques
          <svg
            class="nav-ring"
            aria-hidden="true"
            focusable="false"
            viewBox="0 0 100 40"
            preserveAspectRatio="none"
          >
            <path
              class="nav-ring__stroke"
              pathLength="100"
              d="M50,1.5 H78.5 A18.5,18.5 0 0 1 78.5,38.5 H21.5 A18.5,18.5 0 0 1 21.5,1.5 H50 Z"
            />
          </svg>
        </a>

        {% if request.state.user %}
        <a
          class="nav-link {% if request.url.path.startswith('/admin') %}is-active{% endif %}"
          href="/admin"
        >
          Admin Panel
          <svg
            class="nav-ring"
            aria-hidden="true"
            focusable="false"
            viewBox="0 0 100 40"
            preserveAspectRatio="none"
          >
            <path
              class="nav-ring__stroke"
              pathLength="100"
              d="M50,1.5 H78.5 A18.5,18.5 0 0 1 78.5,38.5 H21.5 A18.5,18.5 0 0 1 21.5,1.5 H50 Z"
            />
          </svg>
        </a>
        <a class="nav-link" href="/login/logout">
          Déconnexion
          <svg
            class="nav-ring"
            aria-hidden="true"
            focusable="false"
            viewBox="0 0 100 40"
            preserveAspectRatio="none"
          >
            <path
              class="nav-ring__stroke"
              pathLength="100"
              d="M50,1.5 H78.5 A18.5,18.5 0 0 1 78.5,38.5 H21.5 A18.5,18.5 0 0 1 21.5,1.5 H50 Z"
            />
          </svg>
        </a>
        {% else %}
        <a
          class="nav-link {% if request.url.path.startswith('/login') %}is-active{% endif %}"
          href="/login"
        >
          Connexion
          <svg
            class="nav-ring"
            aria-hidden="true"
            focusable="false"
            viewBox="0 0 100 40"
            preserveAspectRatio="none"
          >
            <path
              class="nav-ring__stroke"
              pathLength="100"
              d="M50,1.5 H78.5 A18.5,18.5 0 0 1 78.5,38.5 H21.5 A18.5,18.5 0 0 1 21.5,1.5 H50 Z"
            />
          </svg>
        </a>
        {% endif %}
      </nav>
  </header>

      <!-- Barre mobile centrée -->
      <div class="mobile-topbar" role="region" aria-label="Menu mobile">
        <button
          class="nav-fab"
          aria-expanded="false"
          aria-controls="mobileMenu"
          aria-label="Ouvrir le menu"
        >
          <span class="hamb" aria-hidden="true">
            <span class="bar bar1"></span>
            <span class="bar bar2"></span>
            <span class="bar bar3"></span>
          </span>
        </button>
      </div>
      <!-- Menu déroulant mobile -->
      <div id="mobileMenu" class="mobile-drawer" hidden>
        <nav class="mobile-nav" aria-label="Navigation mobile">
          <a
            class="mobile-link"
            href="/"
            data-active="{{ '1' if request.url.path == '/' else '0' }}"
            >Accueil</a
          >
          <a
            class="mobile-link"
            href="/categories"
            data-active="{{ '1' if request.url.path.startswith('/categories') else '0' }}"
            >Rubriques</a
          >
  
          {% if request.state.user %}
          <a
            class="mobile-link"
            href="/admin"
            data-active="{{ '1' if request.url.path.startswith('/admin') else '0' }}"
            >Admin Panel</a
          >
          <a class="mobile-link" href="/login/logout">Déconnexion</a>
          {% else %}
          <a
            class="mobile-link"
            href="/login"
            data-active="{{ '1' if request.url.path.startswith('/login') else '0' }}"
            >Connexion</a
          >
          {% endif %}
        </nav>
      </div>

      <!-- Backdrop -->
      <div class="mobile-backdrop" hidden></div>

  <!-- Conteneur principal -->
  <div class="container">
    <h1>Rubriques</h1>

  <!-- Filtres -->
  <div class="filters">
    <div class="field">
      <input class="input" type="text" id="search" placeholder="Rechercher un article…" value="{{ search }}">
    </div>
    <div class="field">
      <select class="select" id="categoryFilter" aria-label="Filtrer par catégorie">
        <option value="">Rechercher une catégorie</option>
        {% for cat in categories %}
          <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Grid des articles -->
  <div class="articles-grid" id="articlesGrid">
    {% for article in articles %}
    <article class="article-card" data-category="{{ article.category }}">
      <a class="image-wrapper" href="/articles/{{ article.id }}" aria-label="{{ article.title }}">
        <img src="{{ article.image_url }}" alt="{{ article.title }}">
      </a>
      <div class="content">
        <p class="meta">
          {{ article.created_at.strftime("%d/%m/%Y") }} •
          <a
            class="chip"
            href="/categories?category={{ article.category }}"
            data-category="{{ article.category|lower|replace(' ', '-') }}"
          >
            {{ article.category }}
          </a>
        </p>
        <h3 class="title">
          <a href="/articles/{{ article.id }}">{{ article.title }}</a>
        </h3>
        <p class="subtitle">{{ article.subtitle }}</p>
        <a class="read-more" href="/articles/{{ article.id }}">Lire l'article →</a>
      </div>
    </article>
    {% endfor %}
  </div>


  <!-- Footer -->
  <footer class="container footer" role="contentinfo">
    <div>© Journal du lycée Jean VILAR — Tous droits réservés</div>
    <div class="by">© Made by Team LogicPulse</div>
  </footer>

  <!-- Script filtrage et redirection -->
  <script>
    const searchInput = document.getElementById('search');
    const categorySelect = document.getElementById('categoryFilter');
    const articlesGrid = document.getElementById('articlesGrid');
    const articles = Array.from(articlesGrid.children);

    function filterArticles() {
      const searchText = searchInput.value.toLowerCase();
      const category = categorySelect.value;

      articles.forEach(article => {
        const title = article.querySelector('h3').textContent.toLowerCase();
        const subtitle = article.querySelector('.subtitle').textContent.toLowerCase();
        const articleCategory = article.dataset.category;

        if ((title.includes(searchText) || subtitle.includes(searchText)) &&
            (category === '' || category === articleCategory)) {
          article.style.display = '';
        } else {
          article.style.display = 'none';
        }
      });
    }

    // Appliquer le filtre au chargement
    filterArticles();

    // Rediriger côté serveur lors du changement de catégorie
    categorySelect.addEventListener('change', () => {
      const cat = encodeURIComponent(categorySelect.value);
      const s = encodeURIComponent(searchInput.value);
      window.location.href = `/categories?category=${cat}&search=${s}`;
    });

    // Rediriger côté serveur quand l'utilisateur appuie sur Enter dans la recherche
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const cat = encodeURIComponent(categorySelect.value);
        const s = encodeURIComponent(searchInput.value);
        window.location.href = `/categories?category=${cat}&search=${s}`;
      }
    });
  </script>
</body>
<script>
  (function () {
    const fab = document.querySelector(".nav-fab");
    const drawer = document.getElementById("mobileMenu");
    const backdrop = document.querySelector(".mobile-backdrop");
    if (!fab || !drawer || !backdrop) return;

    function setOpen(isOpen) {
      fab.setAttribute("aria-expanded", String(isOpen));
      drawer.toggleAttribute("hidden", !isOpen);
      backdrop.toggleAttribute("hidden", !isOpen);
      drawer.setAttribute("data-open", String(isOpen));
      backdrop.setAttribute("data-open", String(isOpen));
      document.documentElement.style.overflow = isOpen ? "hidden" : "";
      if (isOpen) {
        const firstLink = drawer.querySelector("a");
        firstLink && firstLink.focus({ preventScroll: true });
      } else {
        fab.focus({ preventScroll: true });
      }
    }
    function toggle() {
      setOpen(fab.getAttribute("aria-expanded") !== "true");
    }

    fab.addEventListener("click", toggle);
    backdrop.addEventListener("click", () => setOpen(false));
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setOpen(false);
    });

    // Sécurité: si on repasse en desktop, on ferme
    const mq = window.matchMedia("(min-width: 521px)");
    mq.addEventListener?.("change", () => setOpen(false));
  })();
</script>
</html>
